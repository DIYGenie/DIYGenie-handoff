// npm i express multer @supabase/supabase-js
import express from "express";
import multer from "multer";
import { createClient } from "@supabase/supabase-js";

const app = express();
const upload = multer({ storage: multer.memoryStorage() });

const supabase = createClient(process.env.SUPABASE_URL, process.env.SUPABASE_SERVICE_ROLE_KEY);
const BUCKET = process.env.SUPABASE_BUCKET || "uploads";
const DECOR8 = "https://api.decor8.ai/generate_designs_for_room";

app.post("/api/projects/:id/preview", upload.single("image"), async (req, res) => {
  try {
    const projectId = req.params.id;
    if (!req.file) return res.status(400).json({ ok:false, error:"no image" });

    // 1) Upload to Supabase
    const fileName = `${projectId}-${Date.now()}.jpeg`;
    const up = await supabase.storage.from(BUCKET).upload(fileName, req.file.buffer, {
      contentType: req.file.mimetype || "image/jpeg", upsert: true
    });
    if (up.error) return res.status(500).json({ ok:false, error: up.error.message });
    const { data: pub } = supabase.storage.from(BUCKET).getPublicUrl(fileName);
    const input_image_url = pub.publicUrl;

    // 2) Call Decor8
    const r = await fetch(DECOR8, {
      method: "POST",
      headers: {
        Authorization: `Bearer ${process.env.DECOR8_API_KEY}`,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        input_image_url,
        room_type: req.body.room_type || "livingroom",
        design_style: req.body.design_style || "modern",
        num_images: 1,
        prompt: req.body.prompt || "",
        scale_factor: 2
      })
    });
    const dj = await r.json();
    if (!r.ok) return res.status(502).json({ ok:false, error:dj?.message || "decor8 failed", data:dj });

    const preview_url = dj.output_image_url || dj.result?.url || dj.images?.[0]?.url;
    if (!preview_url) return res.status(502).json({ ok:false, error:"no preview_url", data:dj });

    // 3) Save to DB
    const upd = await supabase.from("projects").update({ input_image_url, preview_url }).eq("id", projectId);
    if (upd.error) return res.status(500).json({ ok:false, error: upd.error.message });

    res.json({ ok:true, project_id: projectId, input_image_url, preview_url });
  } catch (e) {
    res.status(500).json({ ok:false, error:e.message });
  }
});

export default app;
